name: workflow

on: [pull_request]

jobs:
  frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v2
      - name: Use Node.js
        uses: actions/setup-node@v2
        with:
          node-version: "16.14.0" # .node-versionとバージョンをあわせる
          cache: npm
          cache-dependency-path: ./frontend/package-lock.json
      - name: Install dependencies
        run: npm install
        working-directory: ./frontend
      - name: Run reviewdog
        uses: reviewdog/action-eslint@v1
        with:
          reporter: github-check
          eslint_flags: "src/**/*.{ts,tsx}"
          workdir: ./frontend
  backend:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v2

      - name: Touch .env.development
        run: |
          touch .env.development
          echo "API_CLIENT_URL=${{ secrets.API_CLIENT_URL }}" >> .env.development
          echo "BACKEND_PORT=${{ secrets.BACKEND_PORT }}" >> .env.development
          echo "DB_CONNECTION=${{ secrets.DB_CONNECTION }}" >> .env.development
          echo "DB_USERNAME=${{ secrets.DB_USERNAME }}" >> .env.development
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env.development
          echo "DB_PORT=${{ secrets.DB_PORT }}" >> .env.development
          echo "DB_DATABASE=${{ secrets.DB_DATABASE }}" >> .env.development
          echo "DB_LOCAL=${{ secrets.DB_CONNECTION }}://${{ secrets.DB_USERNAME }}:${{ secrets.DB_PASSWORD }}@localhost:${{ secrets.DB_PORT }}/${{ secrets.DB_DATABASE }}" >> .env.development
        working-directory: ./backend

      - name: Run Docker
        run: docker-compose --env-file .env.development up -d
        working-directory: ./backend

      - name: Use Node.js
        uses: actions/setup-node@v2
        with:
          node-version: "16.14.0" # .node-versionとバージョンをあわせる
          cache: npm
          cache-dependency-path: ./backend/package-lock.json

      - name: Install dependencies
        run: npm install
        working-directory: ./backend

      - name: Run reviewdog
        uses: reviewdog/action-eslint@v1
        with:
          reporter: github-check
          eslint_flags: "{src,test}/**/*.ts"
          workdir: ./backend

      - name: Run migrations
        run: yarn prisma:migration
        working-directory: ./backend

      - name: Run unit test
        run: yarn test
        working-directory: ./backend
